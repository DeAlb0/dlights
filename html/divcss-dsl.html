<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="description" content="flashing ligths to acompany the music" />
  <meta charset="utf-8">
  <title>Lights & Colors</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="DeAlb0">
<script>
  const animl = `
  1 background-color : red; height:0px-->70% ;width:0px-->70vw;left: 50%-->15%;top: 50%-->15%;
  1 border-left-color, border-right-color: blue; width:70vw-->10vw;border-left-width, border-right-width: 0-->30vw; height : 70vh-->100vh; top: 15vh-->0;
  border-top-width, border-bottom-width: 0-->70%-->0%;height -->0
     4 top:-->0%; left: -->40%;top:-->5%;height: -->0%; width: ->0%;border-left-color, border-right-color: -->black;border-left-width, border-right-width: -->10vw; border-top-width, border-bottom-width: -->45vh; border-top-color: ->green;,border-bottom-color:->blue
     0.1 left: ->40%;top:-->5%;height: ->0%; width: ->0%;border-left-color, border-right-color: -->black;border-left-width, border-right-width: -->10vw; border-top-width, border-bottom-width: -->45vh; border-top-color: ->green;,border-bottom-color:->blue
        0.2 rotate: 0deg-->calc(i/64*4*720deg)->0deg;height:0 x calc(i/8*15%)->calc((8-i/8)*15%)

  # border-width: 0->20vh; border-color: ->blue;width:->0;height:->0;left,top:->30%
  # height,width: 4 x calc((i/4+0)*50%);left,top : 4 x calc(30% - i/4*20%);border-color: 0 x green->blue->red;background-color: 0 x red->green->blue
  # border-width: 20vh; border-color: blue;width:0;height:0;left:30%;top:30%
  # 2 border-left-color, border-right-color: blue; width:70vw-->10vw;border-left-width, border-right-width: 0-->30vw; height : 70vh-->100vh; top: 15vh-->0;

  # 0.5 border-left-color: +0.25 15 x red->blue->green ; border-right-color: 15 x blue->green->red; background-color : 8 x grey -> black; 
  
  # 1 border-right-color : 1x red->green->blue
  # 1 border-right-color : yellow
  # | 
  1 height:100vh ; left: 15vw;top: 0vh; border-top-width, border-bottom-width: 0; border-left-color, border-right-color: blue; width:10vw;border-left-width, border-right-width: 30vw;
      1 background-color : -->green; height:100vh ; left: -->0vw;top: 0vh; border-top-width, border-bottom-width: 0; border-left-color, border-right-color: -->green; width:-->100vw;border-left-width, border-right-width: -->0vw;
    3 left: -->0;width -->100vw; top:-->0; border-top-width, border-bottom-width: -->25vh;height:-->0;width:100vw

    # 4 background-color : -->green; height:-->0vh ; left: -->0;top: -->0vh; border-top-width, border-bottom-width: -->25vh; border-left-color, border-right-color: -->green; width:100vw;border-left-width, border-right-width: -->0; height : 0

    # width: 100vw;border-left-width, border-right-width: 0vw; height : 70vh-->0vh; top: 15vh-->0;border-top-width, border-bottom-width: 25vh
    opacity : 90%
    # top: 0; border-top-width, border-bottom-width: 0-->12vw; height: 0-->25vh; width: ->0;left: 0;border-left-width, border-right-width: 0 
    0.5 top: 4 x 0vw->calc(i/4 * 100vh);border-top-color: 6 x red->green->blue;border-bottom-color: 6 x blue->red->green
    top: ->0; border-top-width, border-bottom-width: 12vw; height: 0; width: 100vw;left: 0;border-left-width, border-right-width: 0
    # 0.5 top: 4 x 0vw->calc(1 * 100vh / 4)->calc(2 * 100vh / 4)->calc(3 * 100vh / 4)->calc(4 * 100vh / 4);border-top-color: 8 x red->green->blue;border-bottom-color: 8 x blue->red->green
    `

    dummy = `
    background-color : lightcoral; height:0px-->70% ;width:0px-->70vw;left: 50%-->15%;top: 50%-->15%;
    # 2 background-color : aqua->green->blue->red->blue->green
    border-left-color, border-right-color: blue; width:70vw-->10vw;border-left-width, border-right-width: 0-->30vw; height : 70vh-->100vh; top: 15vh-->0; 
    # 1 border-right-color : 1x red->green->blue
    # 1 border-right-color : yellow
    # | 
    opacity : 90%
    top: 0; border-top-width, border-bottom-width: 12vw; height: 0; width: 100vw;left: 0;border-left-width, border-right-width: 0 
    0.5 top: 4 x calc(i/4 * 100vh);border-top-color: 5 x red->green->blue;border-bottom-color: 5 x blue->red->green
    top: 0; border-top-width, border-bottom-width: 12vw; height: 0; width: 100vw;left: 0;border-left-width, border-right-width: 0 
    # 0.5 top: 4 x 0vw->calc(1 * 100vh / 4)->calc(2 * 100vh / 4)->calc(3 * 100vh / 4)->calc(4 * 100vh / 4);border-top-color: 8 x red->green->blue;border-bottom-color: 8 x blue->red->green
    #######################
    top: 0; border-top-width, border-bottom-width: 12vw; height: 0; width: 100vw;left: 0;border-left-width, border-right-width: 0
    top: 0; border-top-width, border-bottom-width: 0; border-left-width, border-right-width: 12vw
    background-color : lightcoral; height:0px-->70% ;width:0px-->70vw;left: 50%-->15%;top: 50%-->15%;
    border-left-color, border-right-color: blue; width:70vw-->10vw;border-left-width, border-right-width: 0-->30vw; height : 70vh-->100vh; top: 15vh-->0; 

    left: -->0; border-left-width, border-right-width: 30vw-->12vw; width: ->0
    0.5 left: 4x 0vw->calc(1 * 100vw / 8)->calc(2*100vw/8)->calc(3 * 100vw / 8)->calc(4 * 100vw / 8)->calc(5 * 100vw / 8)->calc(6 * 100vw / 8);border-right-color: 15 x blue->green->red;border-left-color: 15 x red->blue->green;
    left: 0; border-left-width, border-right-width: 12vw; width: 0

    0.5 border-left-color: +0.25 15 x red->blue->green ; border-right-color: 15 x blue->green->red; background-color : 8 x grey -> black; opacity: +0.25 20 x 100%->50%; left: 10x 0vw->12vw->24vw->36vw->48vw
    left: 3x 0vw->12vw->24vw->36vw->48vw
    # border-left-color,border-right-color : 3x red->green->blue
    border-left-color : grey
    0.001 height: 70% ;width: 70%;left: 15%;top: 15%;border-left-width, border-right-width: 30vw;width:10vw; height : 100vh; top: 0
    `
    function dlog(text) {
      document.querySelector('.log').innerText += text + "\n"
    }

    function val2arr(text) {
      let result= []
      for ( value1s of val.split('->')) {
        if ( m = value1s.match(/i\/(\d+)/) ) {
          for ( let i = 0 ; i < parseInt(m[1]) ; i++ ) {
             result.push(value1s.replace(/\bi\b/,i))
          }
        } else {
          result.push(value1s)
        }
      }
      // dlog(`val2arr(${text}) = ${JSON.stringify(result)}`)
      return result
    }

  function animlParse(spec) {
    function animline(line) {
      prefix = /^\s*([\d.]+)\b/
      let duration = 1
      if ( pre = line.match(prefix) ) {
        duration = parseFloat(pre[1])
        line = line.replace(prefix,'')
      }
      let lastcount = 1
      let nextstep = reltime + duration
      for ( field of line.split(';')) {
        if ( /^\s*$/.test(field) ) continue
        [prop,val] = field.split(':')
        if ( val === undefined ) {
          console.warn(`animl:warn: no value for property ${prop}`)
          continue
        }
        let offset = 0
        if ( match = val.match(/\+([\d.]+)/) ) {
          offset = parseFloat(match[1])
          val = val.replace(/\+([\d.]+)/,'')
        }
        const multire = /\s*(\d+)\s*x\s*/
        let multi = 1
        if ( multim = val.match(multire) ) {
          multi = parseFloat(multim[1])
          val = val.replace(multire,'')
        }
        let relreltime = reltime + offset
        let values = val2arr(val)
        let valcount = values.length
        if ( multi === 0 ) {
          multi = Math.floor(lastcount / valcount)
        } else {
          lastcount = multi * valcount
        }
        let vcount = 0
        let stepwise = 1
        for ( value1 of values ) {
          let currentmulti = multi
          // if ( propvals[vcount] === undefined ) propvals[vcount] = ""
          value = value1.replace(/-$/,'')
          if ( valcount > 0 && vcount < valcount - 1 ) {
            stepwise = +(value === value1)
            // dlog(`stepwise(${value1},${vcount}/${valcount}) = ${stepwise}   for ${prop}  ` + value1 )
          }
          for ( sprop of prop.replace(/\s+/g,'').split(',')) {
            if ( /^\s*$/.test(value) ) {
              // dlog(`checking lastval[${sprop}] = ${lastval[sprop]}\n`)
              if ( lastval[sprop] !== undefined ) {
                value = lastval[sprop]
              } else {
                value = val.split('->')[1]
              }
              valcount--
              currentmulti = 1
            }
            let key = `${relreltime} ${currentmulti} ${duration} ${valcount} ${stepwise}`
            propvals[key] = (propvals[key] ?? "") + sprop + ":"+value + ";"
            lastval[sprop] = value
          }
          relreltime += duration
          vcount++
        }
        relreltime += ( vcount * (multi-1) - 0 ) * duration
        //  dlog(`multi = ${multi}`)
        if ( relreltime > nextstep ) nextstep = relreltime
      }
      reltime = nextstep
      // combined = propvals.join('\n')
    }
  let reltime = 0  
  propvals = new Map()
  lastval = new Map()
  linestack = []
  let lastlinelvl = undefined
  let lele = {lvl:999}
  for ( line of spec.split("\n") ) {
    line = line.replace(/#.*/,'')
    if ( /^\s*(#.*)?$/.test(line) ) continue
    let linelvl = line.match(/^ */)[0].length
    if ( linelvl > lele.lvl ) {
       linestack.push(lele)
    } else if ( linestack.at(-1) !== undefined && linelvl <= linestack.at(-1).lvl ) {
        let lele = linestack.pop()
        animline(lele.line)
    }
    lele = { lvl: linelvl, line:line}
    animline(line)
  }
  for ( ele of linestack.reverse() ) {
    animline(ele.line)
  }
  dlog(JSON.stringify(propvals,false," "))
    console.log(propvals)
  let keyframe = ""
  for ( stepkey in propvals ) {
    // dlog(`stepkey = ${stepkey}\n`)
    const [relpos,multi,dur,steps,stepwise] = stepkey.split(' ').map(x=>parseFloat(x))
    if ( stepwise ) {
      keyframe += [...Array(multi).keys()].map(i=>`${((relpos+(i*dur*steps))/reltime*100).toFixed(2)}%`).join(',')
      keyframe += `{${propvals[stepkey]}}\n`
    }
    keyframe += [...Array(multi).keys()].map(i=>`${((relpos+(i*dur*steps+dur))/reltime*100-0.01).toFixed(2)}%`).join(',')
    keyframe += `{${propvals[stepkey]}}\n`
  }
  dlog ( keyframe )
  document.querySelector('#autogenstyle').innerHTML = `
  :root {
      --autogenlen: ${reltime}s;
  }
  @keyframes divany {
    ${keyframe}
  }    
  `
}
document.addEventListener("DOMContentLoaded",x=> animlParse(animl))
document.addEventListener("click", function() {
  document.querySelector('.animatable').classList.toggle('animate')
})

</script>  
<style id="autogenstyle"></style>
<style>
    .animate {
        animation: divany var(--autogenlen) infinite 0s;
        position: absolute;
        animation-composition: replace;
        border: solid blue 0px;
    }
    .log { color : white; font-family: 'Courier New', Courier, monospace; }
    body { background-color: black;}
</style>
<body>
  <pre class="log"></pre>
  <div class="animate animatable"></div>
</body>

</html>
