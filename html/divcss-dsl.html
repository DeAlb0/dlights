<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="description" content="flashing ligths to acompany the music" />
  <meta charset="utf-8">
  <title>Lights & Colors</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="DeAlb0">
<script>
  const animl = `
    background-color : lightcoral; height:0px->70% ;width:0px->70%;left: 50%->15%;top: 50%->15%;
    2 background-color : aqua->green->blue->red->blue->green
    border-left-color,border-right-color : 3x red->green->blue
    border-left-color : grey
    `
    function dlog(text) {
      document.querySelector('.log').innerText += text
    }

    function animlParse(spec) {
    let reltime = 0  
    propvals = new Map()
    for ( line of spec.split("\n") ) {
      if ( /^\s*$/.test(line) ) continue
      prefix = /^\s*(\d+)\b/
      let duration = 1
      if ( pre = line.match(prefix) ) {
        duration = parseFloat(pre[1])
        line = line.replace(prefix,'')
      }
      let nextstep = reltime + duration
      for ( field of line.split(';')) {
        if ( /^\s*$/.test(field) ) continue
        [prop,val] = field.split(':')
        if ( val === undefined ) {
          console.warn(`animl:warn: no value for property ${prop}`)
          continue
        }
        const multire = /\s*(\d+)\s*x\s*/
        let multi = 1
        if ( multim = val.match(multire) ) {
          multi = parseFloat(multim[1])
          val = val.replace(multire,'')
        }
        let relreltime = reltime
        let vcount = 0
        for ( value of val.split('->')) {
          // if ( propvals[vcount] === undefined ) propvals[vcount] = ""
          for ( sprop of prop.split(',' )) {
            let key = `${relreltime} ${multi} ${duration}`
            propvals[key] = (propvals[key] ?? "") + sprop + ":"+value + ";"
          }
          relreltime += duration
          vcount++
        }
        relreltime += vcount * duration * (multi-1)
        //  dlog(`multi = ${multi}`)
        if ( relreltime > nextstep ) nextstep = relreltime
      }
      reltime = nextstep
      // combined = propvals.join('\n')
    }
    dlog(JSON.stringify(propvals,false," "))
      console.log(propvals)
    let keyframe = ""
    for ( stepkey in propvals ) {
      dlog(`stepkey = ${stepkey}\n`)
      let [relpos,multi,dur] = stepkey.split(' ')
      relpos = parseFloat(relpos)
      multi = parseInt(multi)
      dur = parseFloat(dur)
      keyframe += [...Array(5).keys()].map(i=>`${((relpos+(i*dur*multi))/reltime*100).toFixed(2)}%`).join(',')
      keyframe += `{${propvals[stepkey]}}\n`
    }
    dlog ( keyframe )
    document.querySelector('#autogenstyle').innerHTML = `
    :root {
       --autogenlen: ${reltime}s;
    }
    @keyframes divany {
      ${keyframe}
    }    
    `
  }
  document.addEventListener("DOMContentLoaded",x=> animlParse(animl))
</script>  
<style id="autogenstyle"></style>
<style>
   @keyframes divanyx {
        0% { background-color : lightcoral; height:0px;width:0px;left: 50%;top: 50%;}
        1% { background-color : lightcoral; height:70%;width:70%;left: 15%;top: 15%;}
        2% { background-color: aqua;} 
        3% { background-color: green;} 
        4% { background-color: blue;} 
        5% { background-color: red;}
        5.01% { background-color: blue;}
        5.5% { background-color: blue;}
        5.51% { background-color: green;}
        6% { background-color: green;}
        6.01% { background-color: red;}
        6.5% { background-color: red;height:70%;width:70%;left: 15vh;top: 15%; border-width: 0; border-width-left: 35vh; border-width-right: 35vh; }
        8% { background-color: red;height:0%;width:0%;left: 15vh;top: 15%; border-style: solid;border-color:black;border-width: 35vh; border-left-color: blue;border-right-color: blue;}
        8.01% { border-left-color: blue;border-right-color: blue;}
        8.5% { border-left-color: green;border-right-color: green;}
        8.51% { border-left-color: green;border-right-color: green;}
        9% { border-left-color: red;border-right-color:red;border-width: 35vh; }
        9% { border-left-width: 15vh; border-right-width: 15vh; border-top-width: 70vh; border-bottom-width: 70vh; left: 35vh ; top: -20vh}
        9.5% { border-left-color:red;border-right-color:red;} 
        9.51% { border-left-color: blue;border-right-color:blue;} 
        10% { border-left-color: blue;border-right-color:blue;} 
        11.01% { transform: rotate(0deg) }
        12.0% { transform: rotate(720deg) }
        13.0% { transform: rotate(0deg) }
        12% { border-radius: 50% }
        6%,4%,2%,13%,15% { border-radius: 0% }
        5%,3%,14%,16% { border-radius: 100% }
        89% { width, height : 0}
        90% { border-left-width: 15vh; border-right-width: 15vh; border-top-width: 70vh; border-bottom-width: 70vh; left: 35vh ; top: -20vh}
    } 
    div {
        animation: divany var(--autogenlen) infinite 0s;
        position: absolute;
        animation-composition: replace;
    }
    .log { color : white; font-family: 'Courier New', Courier, monospace; }
    body { background-color: black;}
</style>
<body>
<div></div>
<div class="log"></div>
</body>

</html>
