
<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="description" content="flashing ligths to acompany the music" />
  <meta charset="utf-8">
  <title>Lights & Colors</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="DeAlb0">


<style>
    :root {
        --nsteps: 8;
        --blocks: 4;
        --clustersize: 3;
        --duration: 3.9s; 
        --dutyc: 70%;
        --raisc: 10%;
    }
    .light {
        animation: var(--duration) infinite walker;
        /* background-color: red; */
        width : 100%;
        height: 100%;
        opacity: 0;
    }
    .light {
        border-radius : 50%;
        width : 1px;
        height: 1px;
        left : 50%;
        top : 50%;
        position: absolute;
        transition: 0.5s transform 0s;
    }
    .lights {
        position: static;
        display:block;
        width : 100%;
        height: 100%;
        overflow: hidden;
        background-color: black;
    }
    .lightrect {
        position:absolute;
        overflow: hidden;
        margin: 20px;
    }
    .xxlight:not(.lighton) {
        /** turn afterflow off */
        background-color :hsl(0deg 90% 00%) !important;
    }

    .light:not(.lighton) {
        /*****
        width : 20vw;
        height: 20vw;
        *********/
        transform: scale(500);
        transition: 0.1s transform 0s;
    }
    body {
        background-color: black;
    }
    .paraminfo { color : red ; font-family: 'Courier New', Courier, monospace;}

</style>
<script>

var lightUpdateTime = 10000
const lrows = 4
const lcols = 8
const lcount = lrows * lcols
var cycle = 0
var metacycle = 0
var diva = []


function mody(x,l,mode) {
    let period = l
    if ( mode === 1 ) {
        period = 2 * period - 2
    }
    const res = Math.abs(((Math.floor(x)+period)%period)-(mode*(l-1)))
    return res
}


const paramsDefault = Array.of(0,0,0,0,1,1,1,1)
var params = Array.from(paramsDefault)

var paraChanges = [undefined,0,0]
var metacycle = 0

function metacycleNextold() {
    let pi = 0
    let i = paraChanges[pi]
    if ( i === undefined ) {
        i = 0
        params[i] = paramsDefault[i]+1
    } else {
        params[i] = paramsDefault[i]
        i++
        if ( i >= params.length ) {
            i = 0
        }
        params[i] = paramsDefault[i]+1
    }
    paraChanges[pi] = i
    let div = document.querySelector('.paraminfo')
    if ( div !== null ) {
        div.innerText = `${i} : ${params}`
    }
}

function plog(text) {
    let div = document.querySelector('.paraminfo')
    if ( div !== null ) {
        div.innerText = text
    }
}


function idiv(a,b) {
    return Math.floor(a/b)
}


var xmode = [1,8,1,1,5,1]
var ymode = [1,4,1,3,2,1]
var cxmode = [1,4,1,2,1]
var cymode = [1,4,1,3,1]

metamodes = [
    [ [1,8,1,1,1,1], [],            [1,4,1,24,1,1], [1,1,1,3,1] ],
    [ [2,8,0,1,1,1], [],            [1,4,1,24,1,1], [1,1,1,3,1] ],
    [ [1,8,1,1,3,1], [],            [1,4,1,24,1,1], [1,1,1,3,1] ],
    [ [1,2,1,99,3,1], [1,4,1,1,1,1], [1,2,1,2,1,1], [1,4,1,3,1] ],
    [ [1,8,1,1,2,1], [1,4,1,2,2,1], [1,4,1,6,2,1], [1,1,1,3,3,1] ],
    [ [1,8,1,1,4,1], [1,4,1,3,2,1], [1,4,1,2,1], [1,4,1,3,1] ],
    [ [1,8,1,1,3,1], [1,4,1,3,2,1], [1,4,1,2,1], [1,4,1,3,1] ],
    [ [1,8,1,1,2,1], [1,4,1,3,2,1], [1,4,1,2,1], [1,4,1,3,1] ],
]

metamodes_alt = [
    [ [1,8,1,1,1,1], [],            [1,4,1,24,1,1], [1,1,1,3,1] ],
    [ [2,8,0,1,1,1], [],            [1,4,1,24,1,1], [1,1,1,3,1] ],
    [ [1,8,1,1,1,1], [],            [1,2,1,2,1,1], [1,1,1,3,1] ],
    [ [1,8,1,1,2,1], [],            [1,1,1,2,1], [1,1,1,3,1] ],
    [ [1,8,1,1,2,1], [],            [1,2,0,2,1,1], [1,1,1,3,1] ],
    [ [1,2,1,99,3,1], [1,4,1,1,1,1], [1,2,1,2,1,1], [1,4,1,3,1] ],
    [ [1,8,1,1,5,1], [1,4,1,3,2,1], [1,4,1,2,1], [1,4,1,3,1] ],
    [ [1,8,1,1,4,1], [1,4,1,3,2,1], [1,4,1,2,1], [1,4,1,3,1] ],
    [ [1,8,1,1,3,1], [1,4,1,3,2,1], [1,4,1,2,1], [1,4,1,3,1] ],
    [ [1,8,1,1,2,1], [1,4,1,3,2,1], [1,4,1,2,1], [1,4,1,3,1] ],
    [ [1,8,1,1,1,1], [1,4,1,3,2,1], [1,4,1,2,1], [1,4,1,3,1] ],
]

function metacycleNext() {
    if ( metacycle++ >= metamodes.length-1 )
        metacycle = 0
    cycle = 0
}


function lightUpdate() {
//    let tval = mody(cycle/buncht,max/(tmode+1),tmode)
    plog(`${cycle}`)
    let xmode = metamodes[metacycle][0]
    let ymode = metamodes[metacycle][1]
    let cxmode = metamodes[metacycle][2]
    let cymode = metamodes[metacycle][3]
    cycle++
    if ( cycle > 2 * lcount ) {
        metacycleNext()
    }
    setTimeout(lightUpdate,lightUpdateTime)
    // if ( lightUpdateTime > 200 )    lightUpdateTime /= 1.1 
}

// TODO: fix with consistent columns and t row handling
const lcols2 = lcols
const lrows2 = lrows
function lights() {
    for ( base of document.querySelectorAll('.lights')) {
        let lcols = base.getAttribute('columns') || lcols2
        let lrows = base.getAttribute('rows') || lrows2
        for ( i = 0 ; i < lcount ; i++ ) {
            let ndiv = document.createElement('div')
            let ndivrect = document.createElement('div')
            ndiv.classList.add('light')
            ndivrect.classList.add('lightrect')
            ndiv.classList.add('light'+i)
            base.appendChild(ndivrect)
            ndivrect.appendChild(ndiv)
            diva.push(ndiv)
            // ndiv.style.left = `${(i % lcols + 0.5)*100/lcols}%`
            // ndiv.style.top = `${(Math.floor(i/lcols)+0.5)*100/lrows}%`
            let column = i % lcols
            let row = Math.floor(i/lcols)
            ndivrect.classList.add('col'+column)
            ndivrect.classList.add('row'+row)
            ndivrect.style.left = `${(i % lcols)*100/lcols}%`
            ndivrect.style.top = `${(Math.floor(i/lcols))*100/lrows}%`
            ndivrect.style.width = `${100/lcols-1}%`
            ndivrect.style.height = `${100/lrows-1}%`
        }
    }
    lightUpdate()
    document.body.addEventListener("click", metacycleNext)
    myStyle = document.createElement("style")
    document.head.appendChild(myStyle)
    let nsteps = 8
    let raiset = 0.6
    let dutyc = 2.999
    let afterglow = 0.1
    for ( stepcount of [8,4]) {
        myStyle.innerHTML += `    
            @keyframes walker${stepcount} {
                0% { opacity: 0% ;}
                ${idiv(100*dutyc*raiset,stepcount)}% { opacity: 100%; }
                ${idiv(100*dutyc       ,stepcount)}% { opacity: 100%; transform: translateX(-40%);}
                ${idiv(100*dutyc*(1+afterglow),stepcount)}% { opacity: 0%;}
                100% { opacity: 0%;}
            }
            @keyframes walkerc${stepcount} {
                0% { background-color: red;}
                33% { background-color: red;}
                34% { background-color: blue;}
                66% { background-color: blue;}
                67% { background-color: green;}
                100% { background-color: green;}
            }
            `
    }
    let ncols = 8
    for ( col = 0 ; col < ncols ; col++ ) {
        myStyle.innerHTML += `
            .hor .col${col} .light { animation-delay: calc(var(--duration)*${col}/var(--nsteps)); }`
    }
    for ( row = 0 ; row < 4 ; row++ ) {
        myStyle.innerHTML += `
            .vert .row${row} .light { animation-delay: calc(var(--duration)*${row}/var(--nsteps)); }`
    }
    for ( col = 0 ; col < ncols ; col++ ) {
        for ( row = 0 ; row < 4 ; row++ ) {
            myStyle.innerHTML += `
                .diag .row${row}.col${col} .light { animation-delay: calc(var(--duration)*(${row} + ${col})/12); }`
        }
    }
    for ( col = 0 ; col < ncols ; col++ ) {
        for ( row = 0 ; row < 4 ; row++ ) {
            myStyle.innerHTML += `
                .both .row${row}.col${col} .light { animation : xwalker4 calc(var(--duration)/2) calc(var(--duration)*${row}/8) infinite,
                  walker8 2.2s calc(var(--duration)*${-col}/8) infinite,
                  walkerc8 7s ${idiv(col,2)*-2.6}s infinite;
                  
                  /* animation-timing-function: linear(0 0%,${1-col/8} 30%,0.1 60%, 2 0%, 5 100%); */
                  /* animation-timing-function: linear(0 0%,1 3%,1 100%); */
                  }` 
            //    walker8 var(--duration) calc(var(--duration)*${col}/8) infinite,
            //    walker4 var(--duration) calc(var(--duration)*${idiv(col,2)}/4) infinite,

        }
    }
    myStyle.innerHTML += `
      .light { animation-composition: add; }`
    // document.body.classList.add("vert")
    // document.body.classList.add("hor")
    document.body.classList.add("both")
}
document.addEventListener("DOMContentLoaded", lights) 

var lastx = null
var lasty = null

function mmove(event) {
    y = event.y
    x = event.x
    if ( lastx === null ) {
        lastx = x
        lasty = y
    } else {
        let xdiff = x - lastx 
        lightUpdateTime = Math.max(50,xdiff + 500)
        lastx = x - (lightUpdateTime - 500)
    }
} 
addEventListener("mousemove", mmove);

</script>

</head>

<body>

<div class="paraminfo"></div>
<div class="lights">
  
</div>

<script>
</script>

</body>
</html>